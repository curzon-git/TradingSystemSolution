<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading System - Grapes.js Interface</title>
    
    <!-- SignalR Client Library -->
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    
    <!-- Grapes.js CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    
    <!-- Trading Interface Styles -->
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background-color: #4CAF50;
            color: white;
        }

        .connection-status.connecting {
            background-color: #FF9800;
            color: white;
        }

        .connection-status.disconnected {
            background-color: #f44336;
            color: white;
        }

        /* Trading Container */
        .trading-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Header */
        .trading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .trading-title {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .trading-controls {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* Flexible Table Styles */
        .table-container {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
        }

        .table-controls {
            display: flex;
            gap: 10px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .flexible-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .flexible-table th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .flexible-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .flexible-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .flexible-table tbody tr.selected {
            background-color: #e3f2fd;
        }

        /* Cell Types */
        .cell-currency {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .cell-number {
            text-align: right;
        }

        .cell-boolean {
            text-align: center;
        }

        .cell-date {
            font-size: 12px;
            color: #666;
        }

        /* Toggle Switches */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Editable Cells */
        .editable-cell {
            cursor: pointer;
            position: relative;
        }

        .editable-cell:hover {
            background-color: #f0f0f0;
        }

        .editable-cell input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px;
            font-size: inherit;
            font-family: inherit;
        }

        .editable-cell input:focus {
            outline: 2px solid #3498db;
            background: white;
        }

        /* Field Container */
        .field-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .field-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .field-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .field-value {
            font-size: 18px;
            font-weight: bold;
        }

        .field-currency {
            color: #27ae60;
        }

        .field-currency.negative {
            color: #e74c3c;
        }

        /* Console */
        .console-container {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            overflow: hidden;
        }

        .console-header {
            background: #34495e;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-content {
            height: 200px;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .console-message {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .trading-container {
                margin: 10px;
                padding: 15px;
            }

            .trading-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .table-wrapper {
                font-size: 12px;
            }

            .flexible-table th,
            .flexible-table td {
                padding: 8px 4px;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Grapes.js Editor Styles */
        .gjs-editor {
            height: 100vh;
        }

        .gjs-cv-canvas {
            background: #f5f5f5;
        }

        /* Trading Component Styles for Grapes.js */
        .trading-component {
            border: 2px dashed #3498db;
            padding: 10px;
            margin: 10px 0;
            background: rgba(52, 152, 219, 0.1);
        }

        .trading-component.selected {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status disconnected">Disconnected</div>

    <!-- Main Trading Interface -->
    <div class="trading-container">
        <!-- Header -->
        <div class="trading-header">
            <h1 class="trading-title">Trading System Interface</h1>
            <div class="trading-controls">
                <button class="btn btn-primary" onclick="refreshData()">
                    <span id="refreshIcon">🔄</span> Refresh
                </button>
                <button class="btn btn-success" onclick="addPosition()">➕ Add Position</button>
                <button class="btn btn-primary" onclick="toggleGrapesEditor()">🎨 Edit Mode</button>
            </div>
        </div>

        <!-- Account Summary Fields -->
        <div class="field-container" id="fieldContainer">
            <!-- Fields will be populated dynamically -->
        </div>

        <!-- Flexible Trading Table -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Trading Positions</h3>
                <div class="table-controls">
                    <button class="btn btn-success" onclick="addTableRow()">➕ Add Row</button>
                    <button class="btn btn-primary" onclick="exportTableData()">📊 Export</button>
                    <button class="btn btn-primary" onclick="customizeColumns()">⚙️ Columns</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table class="flexible-table" id="positionsTable">
                    <thead id="tableHeader">
                        <!-- Headers will be populated dynamically -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Console -->
        <div class="console-container">
            <div class="console-header">
                <span>System Console</span>
                <button class="btn btn-danger" onclick="clearConsole()" style="padding: 5px 10px; font-size: 12px;">Clear</button>
            </div>
            <div class="console-content" id="consoleContent">
                <!-- Console messages will appear here -->
            </div>
        </div>
    </div>

    <!-- Grapes.js Editor Container (Hidden by default) -->
    <div id="grapesEditor" style="display: none;"></div>

    <!-- JavaScript -->
    <script>
        // ========== GLOBAL VARIABLES ==========
        let connection = null;
        let currentWebPageData = null;
        let currentTableData = null;
        let selectedRows = new Set();
        let editingCell = null;
        let grapesEditor = null;
        let isEditorMode = false;

        // ========== TRADING INTERFACE CLASS ==========
        class TradingInterface {
            constructor() {
                this.connection = null;
                this.tables = new Map();
                this.fields = new Map();
                this.eventHandlers = new Map();
                this.isConnected = false;
            }

            // Initialize SignalR connection
            async initialize() {
                try {
                    this.connection = new signalR.HubConnectionBuilder()
                        .withUrl("/tradingHub")
                        .withAutomaticReconnect([0, 2000, 10000, 30000])
                        .configureLogging(signalR.LogLevel.Information)
                        .build();

                    this.setupEventHandlers();
                    await this.connection.start();
                    this.isConnected = true;
                    this.updateConnectionStatus('connected');
                    
                    console.log('SignalR connection established');
                    await this.loadInitialData();
                } catch (error) {
                    console.error('SignalR connection failed:', error);
                    this.updateConnectionStatus('disconnected');
                }
            }

            // Setup SignalR event handlers
            setupEventHandlers() {
                // Connection events
                this.connection.onreconnecting(() => {
                    console.log('SignalR reconnecting...');
                    this.updateConnectionStatus('connecting');
                });

                this.connection.onreconnected(() => {
                    console.log('SignalR reconnected');
                    this.updateConnectionStatus('connected');
                    this.loadInitialData();
                });

                this.connection.onclose(() => {
                    console.log('SignalR connection closed');
                    this.updateConnectionStatus('disconnected');
                    this.isConnected = false;
                });

                // Data update events
                this.connection.on("WebPageDataUpdate", (data) => {
                    console.log('Received webpage data update:', data);
                    this.handleWebPageDataUpdate(data);
                });

                this.connection.on("TableDataUpdate", (tableId, tableData) => {
                    console.log('Received table data update:', tableId, tableData);
                    this.handleTableDataUpdate(tableId, tableData);
                });

                this.connection.on("FieldDataUpdate", (fieldId, fieldData) => {
                    console.log('Received field data update:', fieldId, fieldData);
                    this.handleFieldDataUpdate(fieldId, fieldData);
                });

                this.connection.on("EventNotification", (eventData) => {
                    console.log('Received event notification:', eventData);
                    this.handleEventNotification(eventData);
                });

                this.connection.on("TableOperationResult", (result) => {
                    console.log('Received table operation result:', result);
                    this.handleTableOperationResult(result);
                });

                this.connection.on("ConsoleUpdate", (messages) => {
                    this.updateConsole(messages);
                });

                this.connection.on("Error", (message) => {
                    console.error('SignalR error:', message);
                    this.showNotification('Error: ' + message, 'error');
                });
            }

            // Update connection status indicator
            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `connection-status ${status}`;
                
                switch (status) {
                    case 'connected':
                        statusElement.textContent = 'Connected';
                        break;
                    case 'connecting':
                        statusElement.textContent = 'Connecting...';
                        break;
                    case 'disconnected':
                        statusElement.textContent = 'Disconnected';
                        break;
                }
            }

            // Load initial data
            async loadInitialData() {
                try {
                    if (!this.isConnected) return;

                    // Get complete webpage data
                    const webPageData = await this.connection.invoke("GetWebPageData");
                    if (webPageData) {
                        currentWebPageData = webPageData;
                        this.renderWebPageData(webPageData);
                    }
                } catch (error) {
                    console.error('Error loading initial data:', error);
                }
            }

            // Render complete webpage data
            renderWebPageData(data) {
                // Render fields
                this.renderFields(data.fields);
                
                // Render tables
                if (data.tables && data.tables.positions_table) {
                    this.renderTable('positions_table', data.tables.positions_table);
                }
            }

            // Render fields
            renderFields(fields) {
                const container = document.getElementById('fieldContainer');
                container.innerHTML = '';

                for (const [fieldId, fieldData] of Object.entries(fields)) {
                    const fieldElement = this.createFieldElement(fieldId, fieldData);
                    container.appendChild(fieldElement);
                }
            }

            // Create field element
            createFieldElement(fieldId, fieldData) {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'field-item';
                fieldDiv.setAttribute('data-field-id', fieldId);

                const label = document.createElement('div');
                label.className = 'field-label';
                label.textContent = fieldData.fieldName || fieldId;

                const value = document.createElement('div');
                value.className = 'field-value';
                
                if (fieldData.dataType === 'currency') {
                    value.className += ' field-currency';
                    if (parseFloat(fieldData.value) < 0) {
                        value.className += ' negative';
                    }
                    value.textContent = this.formatCurrency(fieldData.value);
                } else {
                    value.textContent = fieldData.value;
                }

                fieldDiv.appendChild(label);
                fieldDiv.appendChild(value);

                return fieldDiv;
            }

            // Render table
            renderTable(tableId, tableData) {
                currentTableData = tableData;
                this.renderTableHeaders(tableData.columns);
                this.renderTableRows(tableData.rows);
            }

            // Render table headers
            renderTableHeaders(columns) {
                const headerRow = document.getElementById('tableHeader');
                headerRow.innerHTML = '';

                const headerRowElement = document.createElement('tr');
                
                columns.forEach(column => {
                    if (column.visible) {
                        const th = document.createElement('th');
                        th.textContent = column.name;
                        th.setAttribute('data-column-id', column.id);
                        th.setAttribute('data-data-type', column.dataType);
                        headerRowElement.appendChild(th);
                    }
                });

                // Add actions column
                const actionsHeader = document.createElement('th');
                actionsHeader.textContent = 'Actions';
                actionsHeader.style.width = '120px';
                headerRowElement.appendChild(actionsHeader);

                headerRow.appendChild(headerRowElement);
            }

            // Render table rows
            renderTableRows(rows) {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                rows.forEach((row, index) => {
                    const tr = this.createTableRow(row, index);
                    tbody.appendChild(tr);
                });
            }

            // Create table row
            createTableRow(rowData, rowIndex) {
                const tr = document.createElement('tr');
                tr.setAttribute('data-row-index', rowIndex);
                
                // Add click handler for row selection
                tr.addEventListener('click', (e) => {
                    if (!e.target.closest('.toggle-switch') && !e.target.closest('button')) {
                        this.handleRowClick(rowIndex, e);
                    }
                });

                // Add double-click handler
                tr.addEventListener('dblclick', () => {
                    this.handleRowDoubleClick(rowIndex);
                });

                // Create cells based on visible columns
                if (currentTableData && currentTableData.columns) {
                    currentTableData.columns.forEach(column => {
                        if (column.visible) {
                            const td = this.createTableCell(rowData, column, rowIndex);
                            tr.appendChild(td);
                        }
                    });
                }

                // Add actions cell
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="btn btn-danger" onclick="deleteRow(${rowIndex})" style="padding: 4px 8px; font-size: 12px;">Delete</button>
                `;
                tr.appendChild(actionsCell);

                return tr;
            }

            // Create table cell
            createTableCell(rowData, column, rowIndex) {
                const td = document.createElement('td');
                td.setAttribute('data-column-id', column.id);
                td.setAttribute('data-row-index', rowIndex);

                const value = rowData[column.id];

                switch (column.dataType) {
                    case 'boolean':
                        td.className = 'cell-boolean';
                        if (column.editable) {
                            td.innerHTML = `
                                <label class="toggle-switch">
                                    <input type="checkbox" ${value ? 'checked' : ''} 
                                           onchange="handleToggleChange(${rowIndex}, '${column.id}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            `;
                        } else {
                            td.textContent = value ? 'Yes' : 'No';
                        }
                        break;

                    case 'currency':
                        td.className = 'cell-currency';
                        td.textContent = this.formatCurrency(value);
                        if (column.editable) {
                            this.makeEditable(td, rowIndex, column.id, 'number');
                        }
                        break;

                    case 'number':
                        td.className = 'cell-number';
                        if (column.format === 'P2') {
                            td.textContent = this.formatPercentage(value);
                        } else {
                            td.textContent = this.formatNumber(value);
                        }
                        if (column.editable) {
                            this.makeEditable(td, rowIndex, column.id, 'number');
                        }
                        break;

                    case 'date':
                        td.className = 'cell-date';
                        td.textContent = this.formatDate(value);
                        break;

                    default:
                        td.textContent = value || '';
                        if (column.editable) {
                            this.makeEditable(td, rowIndex, column.id, 'text');
                        }
                        break;
                }

                return td;
            }

            // Make cell editable
            makeEditable(cell, rowIndex, columnId, inputType) {
                cell.className += ' editable-cell';
                cell.addEventListener('click', () => {
                    if (editingCell) return;
                    
                    editingCell = cell;
                    const currentValue = cell.textContent;
                    
                    const input = document.createElement('input');
                    input.type = inputType;
                    input.value = currentValue;
                    input.style.width = '100%';
                    
                    input.addEventListener('blur', () => {
                        this.finishEditing(cell, input, rowIndex, columnId);
                    });
                    
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            this.finishEditing(cell, input, rowIndex, columnId);
                        } else if (e.key === 'Escape') {
                            cell.textContent = currentValue;
                            editingCell = null;
                        }
                    });
                    
                    cell.innerHTML = '';
                    cell.appendChild(input);
                    input.focus();
                    input.select();
                });
            }

            // Finish editing cell
            async finishEditing(cell, input, rowIndex, columnId) {
                const newValue = input.value;
                editingCell = null;
                
                try {
                    // Update the cell display
                    cell.textContent = newValue;
                    
                    // Send update to server
                    await this.connection.invoke("HandleTableCellChange", "positions_table", rowIndex, columnId, newValue);
                    
                    // Send event notification
                    await this.sendEvent('table.cell.changed', 'table', 'positions_table', {
                        rowIndex: rowIndex,
                        columnId: columnId,
                        oldValue: cell.getAttribute('data-old-value'),
                        newValue: newValue
                    });
                    
                } catch (error) {
                    console.error('Error updating cell:', error);
                    this.showNotification('Error updating cell: ' + error.message, 'error');
                }
            }

            // Handle row click
            async handleRowClick(rowIndex, event) {
                const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
                
                if (event.ctrlKey || event.metaKey) {
                    // Multi-select
                    if (selectedRows.has(rowIndex)) {
                        selectedRows.delete(rowIndex);
                        row.classList.remove('selected');
                    } else {
                        selectedRows.add(rowIndex);
                        row.classList.add('selected');
                    }
                } else {
                    // Single select
                    document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
                    selectedRows.clear();
                    selectedRows.add(rowIndex);
                    row.classList.add('selected');
                }

                // Send selection event
                await this.sendEvent('table.row.selected', 'table', 'positions_table', {
                    rowIndex: rowIndex,
                    selectedRows: Array.from(selectedRows),
                    rowData: currentTableData.rows[rowIndex]
                });
            }

            // Handle row double-click
            async handleRowDoubleClick(rowIndex) {
                console.log('Row double-clicked:', rowIndex);
                
                // Send double-click event
                await this.sendEvent('table.row.doubleclick', 'table', 'positions_table', {
                    rowIndex: rowIndex,
                    rowData: currentTableData.rows[rowIndex]
                });
            }

            // Send event to server
            async sendEvent(eventType, source, sourceId, data) {
                try {
                    if (!this.isConnected) return;

                    const eventData = {
                        eventType: eventType,
                        source: source,
                        sourceId: sourceId,
                        data: data,
                        timestamp: new Date().toISOString(),
                        userId: 'web_user'
                    };

                    await this.connection.invoke("ReceiveEvent", eventData);
                } catch (error) {
                    console.error('Error sending event:', error);
                }
            }

            // Handle data updates from server
            handleWebPageDataUpdate(data) {
                currentWebPageData = data;
                this.renderWebPageData(data);
            }

            handleTableDataUpdate(tableId, tableData) {
                if (tableId === 'positions_table') {
                    this.renderTable(tableId, tableData);
                }
            }

            handleFieldDataUpdate(fieldId, fieldData) {
                const fieldElement = document.querySelector(`[data-field-id="${fieldId}"]`);
                if (fieldElement) {
                    const valueElement = fieldElement.querySelector('.field-value');
                    if (fieldData.dataType === 'currency') {
                        valueElement.textContent = this.formatCurrency(fieldData.value);
                    } else {
                        valueElement.textContent = fieldData.value;
                    }
                }
            }

            handleEventNotification(eventData) {
                console.log('Event notification:', eventData);
                // Handle specific events as needed
            }

            handleTableOperationResult(result) {
                if (result.success) {
                    this.showNotification(result.message, 'success');
                } else {
                    this.showNotification('Error: ' + result.message, 'error');
                }
            }

            // Update console
            updateConsole(messages) {
                const consoleContent = document.getElementById('consoleContent');
                consoleContent.innerHTML = '';
                
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'console-message';
                    messageDiv.textContent = message;
                    consoleContent.appendChild(messageDiv);
                });
                
                consoleContent.scrollTop = consoleContent.scrollHeight;
            }

            // Utility methods
            formatCurrency(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(value || 0);
            }

            formatNumber(value) {
                return new Intl.NumberFormat('en-US').format(value || 0);
            }

            formatPercentage(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'percent',
                    minimumFractionDigits: 2
                }).format(value || 0);
            }

            formatDate(value) {
                if (!value) return '';
                const date = new Date(value);
                return date.toLocaleTimeString();
            }

            showNotification(message, type) {
                // Simple notification system
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 50px;
                    right: 20px;
                    padding: 10px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 1001;
                    background-color: ${type === 'error' ? '#e74c3c' : '#27ae60'};
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 3000);
            }
        }

        // ========== GLOBAL FUNCTIONS ==========
        
        // Initialize the trading interface
        const tradingInterface = new TradingInterface();

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            await tradingInterface.initialize();
        });

        // Button handlers
        async function refreshData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.innerHTML = '<div class="loading"></div>';
            
            try {
                await tradingInterface.loadInitialData();
            } finally {
                refreshIcon.textContent = '🔄';
            }
        }

        async function addPosition() {
            const newPosition = {
                symbol: prompt('Enter symbol:') || 'NEW',
                quantity: parseInt(prompt('Enter quantity:') || '0'),
                avgPrice: parseFloat(prompt('Enter average price:') || '0'),
                currentPrice: parseFloat(prompt('Enter current price:') || '0'),
                live: false,
                flatten: false,
                strategy: 'Manual',
                account: 'Main',
                notes: '',
                stopLoss: 0,
                takeProfit: 0,
                orderType: 'Market'
            };

            try {
                await tradingInterface.connection.invoke("HandleTableRowAdd", "positions_table", newPosition);
            } catch (error) {
                console.error('Error adding position:', error);
                tradingInterface.showNotification('Error adding position: ' + error.message, 'error');
            }
        }

        async function addTableRow() {
            await addPosition();
        }

        async function deleteRow(rowIndex) {
            if (confirm('Are you sure you want to delete this row?')) {
                try {
                    await tradingInterface.connection.invoke("HandleTableRowDelete", "positions_table", rowIndex);
                } catch (error) {
                    console.error('Error deleting row:', error);
                    tradingInterface.showNotification('Error deleting row: ' + error.message, 'error');
                }
            }
        }

        async function handleToggleChange(rowIndex, columnId, checked) {
            try {
                await tradingInterface.connection.invoke("HandleTableCellChange", "positions_table", rowIndex, columnId, checked);
                
                // Send event notification
                await tradingInterface.sendEvent('toggle.changed', 'table', 'positions_table', {
                    rowIndex: rowIndex,
                    columnId: columnId,
                    newValue: checked
                });
            } catch (error) {
                console.error('Error updating toggle:', error);
                tradingInterface.showNotification('Error updating toggle: ' + error.message, 'error');
            }
        }

        async function clearConsole() {
            try {
                await tradingInterface.connection.invoke("ClearConsole");
            } catch (error) {
                console.error('Error clearing console:', error);
            }
        }

        function exportTableData() {
            if (!currentTableData) return;
            
            const csv = convertTableToCSV(currentTableData);
            downloadCSV(csv, 'trading_positions.csv');
        }

        function convertTableToCSV(tableData) {
            const headers = tableData.columns.filter(col => col.visible).map(col => col.name);
            const rows = tableData.rows.map(row => 
                tableData.columns.filter(col => col.visible).map(col => row[col.id] || '')
            );
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
                
            return csvContent;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function customizeColumns() {
            alert('Column customization feature coming soon!');
        }

        // ========== GRAPES.JS INTEGRATION ==========
        
        function toggleGrapesEditor() {
            if (isEditorMode) {
                exitEditorMode();
            } else {
                enterEditorMode();
            }
        }

        function enterEditorMode() {
            isEditorMode = true;
            
            // Hide the main interface
            document.querySelector('.trading-container').style.display = 'none';
            
            // Show the editor
            document.getElementById('grapesEditor').style.display = 'block';
            
            // Initialize Grapes.js if not already done
            if (!grapesEditor) {
                initializeGrapesEditor();
            }
            
            // Update button text
            document.querySelector('button[onclick="toggleGrapesEditor()"]').textContent = '💾 Save & Exit';
        }

        function exitEditorMode() {
            isEditorMode = false;
            
            // Show the main interface
            document.querySelector('.trading-container').style.display = 'block';
            
            // Hide the editor
            document.getElementById('grapesEditor').style.display = 'none';
            
            // Update button text
            document.querySelector('button[onclick="toggleGrapesEditor()"]').textContent = '🎨 Edit Mode';
        }

        function initializeGrapesEditor() {
            grapesEditor = grapesjs.init({
                container: '#grapesEditor',
                height: '100vh',
                width: 'auto',
                storageManager: {
                    type: 'local',
                    autosave: true,
                    autoload: true,
                    stepsBeforeSave: 1
                },
                blockManager: {
                    appendTo: '.blocks-container',
                    blocks: [
                        {
                            id: 'trading-table',
                            label: 'Trading Table',
                            category: 'Trading',
                            content: `
                                <div class="table-container trading-component" data-table-id="positions_table">
                                    <div class="table-header">
                                        <h3 class="table-title">Trading Positions</h3>
                                        <div class="table-controls">
                                            <button class="btn btn-success">➕ Add Row</button>
                                            <button class="btn btn-primary">📊 Export</button>
                                        </div>
                                    </div>
                                    <div class="table-wrapper">
                                        <table class="flexible-table">
                                            <thead><tr><th>Symbol</th><th>Quantity</th><th>Price</th></tr></thead>
                                            <tbody><tr><td>AAPL</td><td>100</td><td>$150.00</td></tr></tbody>
                                        </table>
                                    </div>
                                </div>
                            `,
                            attributes: { class: 'fa fa-table' }
                        },
                        {
                            id: 'trading-field',
                            label: 'Trading Field',
                            category: 'Trading',
                            content: `
                                <div class="field-item trading-component" data-field-id="custom_field">
                                    <div class="field-label">Custom Field</div>
                                    <div class="field-value">$0.00</div>
                                </div>
                            `,
                            attributes: { class: 'fa fa-square' }
                        },
                        {
                            id: 'trading-console',
                            label: 'Trading Console',
                            category: 'Trading',
                            content: `
                                <div class="console-container trading-component">
                                    <div class="console-header">
                                        <span>System Console</span>
                                        <button class="btn btn-danger">Clear</button>
                                    </div>
                                    <div class="console-content">
                                        <div class="console-message">[12:00:00] System ready</div>
                                        <div class="console-message">[12:00:01] Connected to trading system</div>
                                    </div>
                                </div>
                            `,
                            attributes: { class: 'fa fa-terminal' }
                        }
                    ]
                },
                layerManager: {
                    appendTo: '.layers-container'
                },
                traitManager: {
                    appendTo: '.traits-container'
                },
                selectorManager: {
                    appendTo: '.styles-container'
                },
                styleManager: {
                    appendTo: '.styles-container',
                    sectors: [
                        {
                            name: 'General',
                            open: false,
                            properties: [
                                'display',
                                'position',
                                'top',
                                'right',
                                'left',
                                'bottom'
                            ]
                        },
                        {
                            name: 'Dimension',
                            open: false,
                            properties: [
                                'width',
                                'height',
                                'max-width',
                                'min-height',
                                'margin',
                                'padding'
                            ]
                        },
                        {
                            name: 'Typography',
                            open: false,
                            properties: [
                                'font-family',
                                'font-size',
                                'font-weight',
                                'letter-spacing',
                                'color',
                                'line-height',
                                'text-align',
                                'text-decoration',
                                'text-shadow'
                            ]
                        },
                        {
                            name: 'Decorations',
                            open: false,
                            properties: [
                                'opacity',
                                'border-radius',
                                'border',
                                'box-shadow',
                                'background'
                            ]
                        }
                    ]
                },
                panels: {
                    defaults: [
                        {
                            id: 'layers',
                            el: '.panel__right',
                            resizable: {
                                maxDim: 350,
                                minDim: 200,
                                tc: 0,
                                cl: 1,
                                cr: 0,
                                bc: 0,
                                keyWidth: 'flex-basis'
                            }
                        },
                        {
                            id: 'panel-switcher',
                            el: '.panel__switcher',
                            buttons: [
                                {
                                    id: 'show-layers',
                                    active: true,
                                    label: 'Layers',
                                    command: 'show-layers'
                                },
                                {
                                    id: 'show-style',
                                    active: true,
                                    label: 'Styles',
                                    command: 'show-styles'
                                },
                                {
                                    id: 'show-traits',
                                    active: true,
                                    label: 'Traits',
                                    command: 'show-traits'
                                }
                            ]
                        }
                    ]
                },
                canvas: {
                    styles: [
                        // Include the same styles as the main page
                        'https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js'
                    ],
                    scripts: [
                        // Include necessary scripts for trading functionality
                    ]
                }
            });

            // Add custom commands
            grapesEditor.Commands.add('show-layers', {
                getRowEl(editor) { return editor.getContainer().closest('.editor-row'); },
                getLayersEl(row) { return row.querySelector('.layers-container') },

                run(editor, sender) {
                    const lmEl = this.getLayersEl(this.getRowEl(editor));
                    lmEl.style.display = '';
                },
                stop(editor, sender) {
                    const lmEl = this.getLayersEl(this.getRowEl(editor));
                    lmEl.style.display = 'none';
                }
            });

            grapesEditor.Commands.add('show-styles', {
                getRowEl(editor) { return editor.getContainer().closest('.editor-row'); },
                getStyleEl(row) { return row.querySelector('.styles-container') },

                run(editor, sender) {
                    const smEl = this.getStyleEl(this.getRowEl(editor));
                    smEl.style.display = '';
                },
                stop(editor, sender) {
                    const smEl = this.getStyleEl(this.getRowEl(editor));
                    smEl.style.display = 'none';
                }
            });

            grapesEditor.Commands.add('show-traits', {
                getRowEl(editor) { return editor.getContainer().closest('.editor-row'); },
                getTraitsEl(row) { return row.querySelector('.traits-container') },

                run(editor, sender) {
                    const tmEl = this.getTraitsEl(this.getRowEl(editor));
                    tmEl.style.display = '';
                },
                stop(editor, sender) {
                    const tmEl = this.getTraitsEl(this.getRowEl(editor));
                    tmEl.style.display = 'none';
                }
            });

            // Load the current page content into the editor
            const currentHTML = document.querySelector('.trading-container').outerHTML;
            grapesEditor.setComponents(currentHTML);
        }
    </script>
</body>
</html>

